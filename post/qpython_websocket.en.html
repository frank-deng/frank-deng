<!DOCTYPE html>
<html>
	<head>
		<meta name='viewport' id='viewport' content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no'/>
		<meta charset='UTF-8'/>
		<title>Install and Test QPython WebSocket module `ws4py` - Frank's Space</title>
		<link rel='stylesheet' type='text/css' href='/css/common.css'/>
		<link rel='stylesheet' type='text/css' href='/css/document.css'/>
	</head>
	<body>
		<div class='header-wrapper'>
			<div class='header'>
				
<a class='site-title' href='/'>Frank's Space</a>

<a id='fork_me_on_github' href='https://github.com/frank-deng/'><img alt='Fork me on GitHub' src='https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67' data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"/></a>

			</div>
		</div>
		<div class='main-content'>
			<h1 id="install-and-test-qpython-websocket-module-ws4py">Install and Test QPython WebSocket module <code class="highlighter-rouge">ws4py</code></h1>

<h2 id="install-ws4py-module-for-qpython">Install <code class="highlighter-rouge">ws4py</code> module for QPython</h2>

<ol>
  <li>Download the latest source from <a href="https://pypi.python.org/pypi/ws4py"><code class="highlighter-rouge">https://pypi.python.org/pypi/ws4py</code></a>.</li>
  <li>Open the source archive, enter the root directory, then find out directory <code class="highlighter-rouge">ws4py</code>, then extract it to <code class="highlighter-rouge">com.hipipal.qpyplus/lib/python3.2/site-packages/</code> on the phone’s local storage.</li>
</ol>

<h2 id="test-whether-websocket-server-works-well">Test whether WebSocket server works well</h2>

<p>Save the following code as <code class="highlighter-rouge">WebSocket_Demo.py</code>, then copy <code class="highlighter-rouge">WebSocket_Demo.py</code> to <code class="highlighter-rouge">com.hipipal.qpyplus/scripts3/</code> on the phone’s local storage.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#-*-coding:utf8;-*-
#qpy:3
#qpy:webapp:WebSocket Demo
#qpy://127.0.0.1:4001/

INDEX_HTML = '''
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
	<span class="nt">&lt;head&gt;</span>
	    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">'viewport'</span> <span class="na">id=</span><span class="s">'viewport'</span> <span class="na">content=</span><span class="s">'width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no'</span><span class="nt">/&gt;</span>
	    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">'UTF-8'</span><span class="nt">/&gt;</span>
	    <span class="nt">&lt;title&gt;</span>WebSocket Demo<span class="nt">&lt;/title&gt;</span>
	<span class="nt">&lt;/head&gt;</span>
	<span class="nt">&lt;body&gt;</span>
	    <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">'disp_time'</span><span class="nt">&gt;&lt;/p&gt;</span>
	<span class="nt">&lt;/body&gt;</span>
	<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">'text/javascript'</span><span class="nt">&gt;</span>
<span class="kd">var</span> <span class="nx">disp_time</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'disp_time'</span><span class="p">);</span>
<span class="k">try</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">'ws://127.0.0.1:4002'</span><span class="p">);</span> 
	<span class="nx">socket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'open'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span> 
	    <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nx">disp_time</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
	    <span class="p">};</span>
	<span class="p">});</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="p">}</span>
	<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
'''

# WebSocket Server Part
import os, time, threading;
from datetime import datetime;
from wsgiref.simple_server import make_server;
from ws4py.websocket import WebSocket;
from ws4py.server.wsgirefserver import WSGIServer, WebSocketWSGIRequestHandler;
from ws4py.server.wsgiutils import WebSocketWSGIApplication;

def ThreadWebSocketServer(port):
	class MyWebSocket(WebSocket):
	    __active = True;
	    def opened(self):
	        while self.__active:
	            self.send(datetime.now().strftime('%H:%M:%S.%f'));
	            time.sleep(0.2);
	        
	    def closed(self, code, reason = None):
	        self.__active = False;

	server = make_server('', port,
	    server_class=WSGIServer,
	    handler_class=WebSocketWSGIRequestHandler,
	    app=WebSocketWSGIApplication(handler_cls=MyWebSocket));
	server.initialize_websockets_manager();
	server.serve_forever();

threadWebSocketServer = threading.Thread(target=ThreadWebSocketServer, args=(4002,));
threadWebSocketServer.setDaemon(True);
threadWebSocketServer.start();

# HTTP Server Part
from bottle import route, run, static_file;

@route('/')
def index():
	return INDEX_HTML;

try:
	run(host='', port=4001);
except KeyboardInterrupt:
	pass;
</code></pre>
</div>

<p>Open QPython on the phone, run script <code class="highlighter-rouge">WebSocket_Demo.py</code>.</p>

<p>A few minutes later, when the time displayed in the WebView is updated at a very high frequency, it means <code class="highlighter-rouge">ws4py</code> is successfully installed and then phone’s WebView supports WebSocket.</p>


		</div>
	</body>
</html>

