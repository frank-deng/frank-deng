<!DOCTYPE html>
<html>
	<head>
		<meta name='viewport' id='viewport' content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no'/>
		<meta charset='UTF-8'/>
		<title>QPython安装并测试WebSocket服务器`ws4py` - Frank的空间</title>
		<link rel='stylesheet' type='text/css' href='/css/common.css'/>
		<link rel='stylesheet' type='text/css' href='/css/document.css'/>
	</head>
	<body>
		<div class='header-wrapper'>
			<div class='header'>
				
<a class='site-title' href='/zh-CN/'>Frank的空间</a>


			</div>
		</div>
		<div class='main-content'>
			<h1 id="qpythonwebsocketws4py">QPython安装并测试WebSocket服务器<code class="highlighter-rouge">ws4py</code></h1>

<p>手机上QPython环境的安装过程很简单（直接安装QPython的APK就行了），在此不再赘述。</p>

<h2 id="qpythonws4py">QPython中安装ws4py模块</h2>

<ol>
  <li>从<a href="https://pypi.python.org/pypi/ws4py"><code class="highlighter-rouge">https://pypi.python.org/pypi/ws4py</code></a>上下载最新的代码包（下载列表中后缀为<code class="highlighter-rouge">.tar.gz</code>的文件）。</li>
  <li>打开下载的压缩包，进入根目录后，找到名为<code class="highlighter-rouge">ws4py</code>的目录，然后将该目录解压到手机存储中的<code class="highlighter-rouge">com.hipipal.qpyplus/lib/python3.2/site-packages/</code>目录中。</li>
</ol>

<h2 id="websocket">测试WebSocket服务器是否正常工作</h2>

<p>将以下测试代码保存为<code class="highlighter-rouge">WebSocket_Demo.py</code>，然后将<code class="highlighter-rouge">WebSocket_Demo.py</code>复制到手机存储中的<code class="highlighter-rouge">com.hipipal.qpyplus/scripts3/</code>目录中。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#-*-coding:utf8;-*-
#qpy:3
#qpy:webapp:WebSocket Demo
#qpy://127.0.0.1:4001/

INDEX_HTML = '''
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
	<span class="nt">&lt;head&gt;</span>
	    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">'viewport'</span> <span class="na">id=</span><span class="s">'viewport'</span> <span class="na">content=</span><span class="s">'width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no'</span><span class="nt">/&gt;</span>
	    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">'UTF-8'</span><span class="nt">/&gt;</span>
	    <span class="nt">&lt;title&gt;</span>WebSocket Demo<span class="nt">&lt;/title&gt;</span>
	<span class="nt">&lt;/head&gt;</span>
	<span class="nt">&lt;body&gt;</span>
	    <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">'disp_time'</span><span class="nt">&gt;&lt;/p&gt;</span>
	<span class="nt">&lt;/body&gt;</span>
	<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">'text/javascript'</span><span class="nt">&gt;</span>
<span class="kd">var</span> <span class="nx">disp_time</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'disp_time'</span><span class="p">);</span>
<span class="k">try</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">'ws://127.0.0.1:4002'</span><span class="p">);</span> 
	<span class="nx">socket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'open'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span> 
	    <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nx">disp_time</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
	    <span class="p">};</span>
	<span class="p">});</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="p">}</span>
	<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
'''

# WebSocket Server Part
import os, time, threading;
from datetime import datetime;
from wsgiref.simple_server import make_server;
from ws4py.websocket import WebSocket;
from ws4py.server.wsgirefserver import WSGIServer, WebSocketWSGIRequestHandler;
from ws4py.server.wsgiutils import WebSocketWSGIApplication;

def ThreadWebSocketServer(port):
	class MyWebSocket(WebSocket):
	    __active = True;
	    def opened(self):
	        while self.__active:
	            self.send(datetime.now().strftime('%H:%M:%S.%f'));
	            time.sleep(0.2);
	        
	    def closed(self, code, reason = None):
	        self.__active = False;

	server = make_server('', port,
	    server_class=WSGIServer,
	    handler_class=WebSocketWSGIRequestHandler,
	    app=WebSocketWSGIApplication(handler_cls=MyWebSocket));
	server.initialize_websockets_manager();
	server.serve_forever();

threadWebSocketServer = threading.Thread(target=ThreadWebSocketServer, args=(4002,));
threadWebSocketServer.setDaemon(True);
threadWebSocketServer.start();

# HTTP Server Part
from bottle import route, run, static_file;

@route('/')
def index():
	return INDEX_HTML;

try:
	run(host='', port=4001);
except KeyboardInterrupt:
	pass;
</code></pre>
</div>

<p>然后打开手机中的QPython，单击“程序”，然后在“脚本”一栏中选择<code class="highlighter-rouge">WebSocket_Demo.py</code>，再单击“运行”。</p>

<p>等待一段时间后，当看到WebView中的时间在快速更新时，即表示<code class="highlighter-rouge">ws4py</code>模块安装成功，并且手机上的WebView支持WebSocket。</p>

		</div>
	</body>
</html>

