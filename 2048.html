<!DOCTYPE html>
<html>
	<head>
		<meta name='viewport' id='viewport' content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no'/>
		<meta charset='UTF-8'/>
		<script type='text/javascript' src='js/js.cookie.min.js'></script>
		<script type='text/javascript'>
/* Game Engine */
var isMoveAble = function(array) {
	for (var i = (array.length - 1); i >= 1; i--) {
		if (array[i] != 0 && (array[i] == array[i - 1] || 0 == array[i - 1])) {
			return true;
		}
	}
	return false;
}
var doMove = function(array) {
	var score = 0;
	var hiscore = 0;
	var array_len = array.length;
	
	if (!isMoveAble(array)) {
		return 0;
	}

	//Compress numbers
	while (-1 != array.indexOf(0)) {
		array.splice(array.indexOf(0), 1);
	}
	for (var i = 0; i <= (array_len - array.length + 1); i++) {
		array.push(0);
	}

	//Add numbers
	for (var i = 0; i < (array.length - 1); i++) {
		if (0 == array[i + 1]) {
			break;
		}
		if (array[i] == array[i + 1]) {
			array[i]++;
			score += (1 << array[i]);
			array.splice(i + 1, 1);
			array.push(0);
		}
	}
	return score;
}

var _2048 = function(cookieData) {
	this.ROWS = this.COLS = 4;
	this.stage = [
		[0, 0, 0, 0],
		[0, 0, 0, 0],
		[0, 0, 0, 0],
		[0, 0, 0, 0],
	];
	this.score = 0;
	this.hiScore = 0;
	this.newNumPos = undefined;

	this.newNum = function() {
		var spaces = [];
		for (var row = 0; row < this.ROWS; row++) {
			for (var col = 0; col < this.COLS; col++) {
				if (0 == this.stage[row][col]) {
					spaces.push({col:col, row:row});
				}
			}
		}
		if (spaces.length > 0) {
			var i = Math.floor(Math.random() * spaces.length);
			this.stage[spaces[i].row][spaces[i].col] = (Math.random() < 0.5 ? 1 : 2);
			this.newNumPos = {col: spaces[i].col, row: spaces[i].row};
		}
	};
	this.getTile = function(dir, index) {
		var i, result = [];
		switch(dir) {
			case 'up':
				for (i = 0; i < this.ROWS; i++) {
					result.push(this.stage[i][index]);
				}
			break;
			case 'left':
				for (i = 0; i < this.COLS; i++) {
					result.push(this.stage[index][i]);
				}
			break;
			case 'right':
				for (i = this.COLS - 1; i >= 0; i--) {
					result.push(this.stage[index][i]);
				}
			break;
			case 'down':
				for (i = this.ROWS - 1; i >= 0; i--) {
					result.push(this.stage[i][index]);
				}
			break;
		}
		return result;
	};
	this.setTile = function(dir, index, array) {
		var i, result = [];
		switch(dir) {
			case 'up':
				for (i = 0; i < this.ROWS; i++) {
					this.stage[i][index] = array[i];
				}
			break;
			case 'left':
				for (i = 0; i < this.COLS; i++) {
					this.stage[index][i] = array[i];
				}
			break;
			case 'right':
				for (i = this.COLS - 1; i >= 0; i--) {
					this.stage[index][i] = array[this.COLS - 1 - i];
				}
			break;
			case 'down':
				for (i = this.ROWS - 1; i >= 0; i--) {
					this.stage[i][index] = array[this.ROWS - 1 - i];
				}
			break;
		}
		return result;
	};
	this.move = function(dir) {
		var no_moveable = true;
		for (var i = 0; i < this.ROWS; i++) {
			var array = this.getTile(dir, i);
			if (isMoveAble(array)) {
				this.score += doMove(array);
				no_moveable = false;
			}
			this.setTile(dir, i, array);
		}
		if (!no_moveable) {
			this.newNum();
		}
		if (this.score > this.hiScore) {
			this.hiScore = this.score;
		}
	}
	this.isGameOver = function() {
		for (var i = 0; i < this.ROWS; i++) {
			if (-1 != this.stage[i].indexOf(0)) {
				return false;
			}
		}
		var dirs = ['up', 'left', 'right', 'down'];
		for (var i in dirs) {
			for (var j = 0; j < this.ROWS; j++) {
				var array = this.getTile(dirs[i], j);
				if (isMoveAble(array)) {
					return false;
				}
			}
		}
		return true;
	}
	this.toString = function() {
		var string = Number(this.hiScore).toString(36) + ',' + Number(this.score).toString(36) + ',';
		for (var row = 0; row < this.ROWS; row++) {
			for (var col = 0; col < this.COLS; col++) {
				var val = this.stage[row][col];
				string += Number(val).toString(36);
			}
		}
		return string;
	}
	this.reset = function() {
		this.stage = [
			[0, 0, 0, 0],
			[0, 0, 0, 0],
			[0, 0, 0, 0],
			[0, 0, 0, 0],
		];
		this.score = 0;
		this.newNum();
		this.newNum();
		this.newNumPos = undefined;
	}

	/* Initialize */
	this.reset();

	/* Parse cookie data */
	if (cookieData != '') {
		try {
			var data = cookieData.split(',');
			this.hiScore = parseInt(data[0], 36);
			this.score = parseInt(data[1], 36);
			for (var row = 0; row < this.ROWS; row++) {
				for (var col = 0; col < this.COLS; col++) {
					var addr = col + row * this.COLS;
					this.stage[row][col] = parseInt(data[2].charAt(addr), 36);
				}
			}
		} catch (e) {}
	}
}

/* Game UI */
var Game2048 = function() {
	this.game = new _2048(Cookies.get('Frank_2048'));
	this.drawStage = function() {
		var table = document.getElementById('game2048');
		for (var row = 0; row < this.game.ROWS; row++) {
			for (var col = 0; col < this.game.COLS; col++) {
				var val = this.game.stage[row][col];
				var disp = table.rows[row].cells[col];
				if (0 == val) {
					disp.className = 'empty';
					disp.innerHTML = '';
				} else {
					disp.className = '';
					disp.innerHTML = String(1 << val);
				}

				//Highlight newly added number
				disp.style.fontWeight = 'normal';
				if (undefined != this.game.newNumPos
					&& col == this.game.newNumPos.col
					&& row == this.game.newNumPos.row) {
					disp.style.fontWeight = 'bold';
				}
			}
		}
		document.getElementById('score').innerHTML = this.game.score;
		document.getElementById('hiscore').innerHTML = this.game.hiScore;
	}
	this.move = function(dir) {
		if (this.game.isGameOver()) {
			return;
		}
		this.game.move(dir);
		this.drawStage();
		if (this.game.isGameOver()) {
			document.getElementById('show_game_over').style.display = 'block';
		}
		Cookies.set('Frank_2048', this.game.toString(), {expires:3650});
	}
	this.reset = function() {
		this.game.reset();
		this.drawStage();
		document.getElementById('show_game_over').style.display = 'none';
		Cookies.set('Frank_2048', this.game.toString(), {expires:3650});
	}

	this.drawStage();
	document.getElementById('show_game_over').style.display = 'none';
	if (this.game.isGameOver()) {
		document.getElementById('show_game_over').style.display = 'block';
	}
}

if (!Array.prototype.indexOf) {
	Array.prototype.indexOf = function(elt /*, from*/) {
		var len = this.length >>> 0;

		var from = Number(arguments[1]) || 0;
		from = (from < 0) ? Math.ceil(from) : Math.floor(from);
		if (from < 0) {
			from += len;
		}

		for (; from < len; from++) {
			if (from in this && this[from] === elt) {
				return from;
			}
		}
		return -1;
	};
}
		</script>

		<title>2048</title>
		<style type='text/css'>
			body {
				-moz-user-select:none;
				-webkit-user-select:none;
				cursor: default;
				min-width: 340px;
				margin: 0;
				padding: 10px;
				background-color: #FCFFE8;
				font-family: "sans";
				overflow: hidden;
				text-align: center;
				color: #000;
				font-family:sans,arial,"微软雅黑";
			}
			input:focus, div:focus{
				outline: none;
			}
			p {
				margin: 0;
				margin-top: 10px;
				padding: 0;
			}
			input[type=button] {
				min-width: 50px;
				height: 40px;
			}

			#help {
				font-size: 80%;
			}
			#show_game_over {
				position: relative;
				top: 178px;
				margin: -20px auto;
				width: 240px;
				height: 40px;
				line-height: 40px;
				color: #FFFFFF;
				background: #726554;
				text-align: center;
				font-size: 28px;
				border-radius: 6px;
			}
			#show_score {
				display: inline-block;
				vertical-align: middle;
				margin-left: 10px;
				width:170px;
				text-align: left;
			}
			#show_score td{
				padding-right: 12px;
			}
			#game2048 {
				margin-left: auto;
				margin-right: auto;
				margin-top: 20px;
			}
			#game2048 td {
				margin: 3px;
				padding: 0;
				width: 76px;
				height: 76px;
				border: none;
				background: #e9ceac;
				font-size: 28px;
				overflow: hidden;
				border-radius: 12px;
			}
			#game2048 td.empty {
				background: #C7B093;
			}

			#new_game {
				position: relative;
				z-index: 1000;
				border: none;
				border-radius: 4px;
				color: #FFFFFF;
				background-color: #726554;
			}
			#swipe_receiver {
				position: absolute;
				z-index: 100;
				left: 0;
				right: 0;
				top: 0;
				bottom: 0;
			}
		</style>
	</head>
	<body oncontextmenu='return false'  
		ondragstart='return false'   
		onselectstart ='return false'   
		onselect='document.selection.empty()'   
		oncopy='document.selection.empty()'   
		onbeforecopy='return false'   
		unselectable='on'>
		<div id='menu'>
			<input type='button' id='new_game' value='New Game'/>
			<table id='show_score'>
				<tr><td>Score</td><td id='score'>0</td></tr>
				<tr><td>Best</td><td id='hiscore'>0</td></tr>
			</table>
		</div>
		<div id='help'>
			<p><b>How to play:</b> Use <b>arrow keys</b> or <b>swipe left/right/up/down</b> to move the tiles. When two tiles with the same number touch, they <b>merge into one!</b></p>
			<p>Join the numbers and get to the <b>2048 tile!</b></p>
		</div>
		<div id='show_game_over'>Game Over</div>
		<table id='game2048'>
			<tr>
				<td id='0'></td>
				<td id='1'></td>
				<td id='2'></td>
				<td id='3'></td>
			</tr>
			<tr>
				<td id='4'></td>
				<td id='5'></td>
				<td id='6'></td>
				<td id='7'></td>
			</tr>
			<tr>
				<td id='8'></td>
				<td id='9'></td>
				<td id='10'></td>
				<td id='11'></td>
			</tr>
			<tr>
				<td id='12'></td>
				<td id='13'></td>
				<td id='14'></td>
				<td id='15'></td>
			</tr>
		</table>
		<div id='swipe_receiver'></div>
	</body>
	<script type='text/javascript'>
var game = new Game2048();
document.getElementById('new_game').onclick = function(){
	game.reset();
};
var kbdHandler = function(e) {
	var e = e || event;
	switch (e.keyCode) {
		case 38:
		case 87:
			game.move('up');
		break;
		case 37:
		case 65:
			game.move('left');
		break;
		case 39:
		case 68:
			game.move('right');
		break;
		case 40:
		case 83:
			game.move('down');
		break;
		case 82:	//Reset
			if (e.shiftKey) {
				game.reset();
			}
		break;
	}
}
if (window.onkeydown) {
	window.onkeydown = kbdHandler;
} else {
	document.onkeydown = kbdHandler;
}

//Touch screen handler
(function(receiver,param,handler){
	if(typeof(handler) != 'function') {
		handler = function(){};
	}
	var v_swipe = param.swipeSpeed, d_swipe = param.swipeDistance;
	var eventData = undefined, taps = 0;
	var x0, y0, x1, y1, sx, sy, ts, ts0;
	if (!window.attachEvent) {
		receiver.addEventListener('touchstart', function(e){
			e.preventDefault();
			taps++; if (taps > 1) {return;}
			eventData = undefined;
			x0 = x1 = e.touches[0].clientX;
			y0 = y1 = e.touches[0].clientY;
			sx = sy = 0;
			ts0 = ts = new Date().getTime();
		});
		receiver.addEventListener('touchmove', function(e){
			e.preventDefault();
			if (taps > 1) {return;}
			var x = e.touches[0].clientX;
			var y = e.touches[0].clientY;
			var ts_new = new Date().getTime();
			var dx = (x - x0);
			var dy = (y - y0);
			var vx = (x - x1) / (ts_new - ts);
			var vy = (y - y1) / (ts_new - ts);
			x1 = x; y1 = y; ts = ts_new;

			if (Math.abs(vx) > Math.abs(sx)) {sx = vx;}
			if (Math.abs(vy) > Math.abs(sy)) {sy = vy;}
			if (eventData || ((ts_new - ts0) > param.swipeTime)){
				return;
			}
			if ((Math.abs(sx) > v_swipe && Math.abs(dx) > d_swipe) || (Math.abs(sy) > v_swipe && Math.abs(dy) > d_swipe)) {
				eventData = {type:'swipe'};
				var angle = Math.atan2(dy,dx);
				if (angle > -Math.PI/4 && angle < Math.PI/4) {
					eventData.direction = 'right';
				} else if (angle > Math.PI/4 && angle < Math.PI/4*3) {
					eventData.direction = 'down';
				} else if (angle > Math.PI/4*3 || angle < -Math.PI/4*3) {
					eventData.direction = 'left';
				} else if (angle > -Math.PI/4*3 && angle < -Math.PI/4) {
					eventData.direction = 'up';
				}
				handler.call(receiver,eventData);
			}
		});
		receiver.addEventListener('touchend', function(e){
			e.preventDefault();
			taps--; if (taps > 0) {return;}
			var ts_new = new Date().getTime();
			if (!eventData && (ts_new - ts0) < param.holdTime) {
				handler.call(receiver,{type:'tap'});
			}
			eventData = undefined;
		});
	}
})(document.getElementById('swipe_receiver'), {holdTime:650,swipeTime:500,swipeSpeed:0.5,swipeDistance:40}, function(e){
	switch(e.type){
		case 'swipe':
			game.move(e.direction);
		break;
	}
});
	</script>
</html>

